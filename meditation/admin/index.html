<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Meditation Admin</title>
</head>
<body>
  <script>
    // Tell Decap not to auto-initialize; we'll init after the token is stored.
    window.CMS_MANUAL_INIT = true;

    // === tiny logger ===
    function log(){ try{ console.log.apply(console, arguments); }catch(e){} }

    // Load Decap CMS script and resolve a promise when it's ready.
    function loadCMS(){
      return new Promise((resolve, reject) => {
        if (window.CMS) return resolve();
        const s = document.createElement('script');
        s.src = "https://unpkg.com/decap-cms@^3.3.0/dist/decap-cms.js";
        s.onload = () => { log('[admin] Decap loaded'); resolve(); };
        s.onerror = () => reject(new Error('Failed to load Decap CMS'));
        document.body.appendChild(s);
      });
    }

    // Initialize Decap after token is present
    async function initCMS(){
      await loadCMS();
      try {
        if (window.CMS && typeof window.CMS.init === 'function') {
          log('[admin] Initializing Decap…');
          window.CMS.init();
        } else {
          log('[admin] CMS object not ready');
        }
      } catch (e) {
        console.error('[admin] CMS init error', e);
      }
    }

    function storeToken(token){
      if (!token) return;
      try {
        localStorage.setItem('decap-cms-oauth-token', token);
        localStorage.setItem('netlify-cms-oauth-token', token); // legacy key
        log('[admin] Token stored');
      } catch(e){ console.warn('[admin] Could not store token', e); }
    }

    // 1) Hash fallback (if Worker put #access_token=...)
    (function fromHash(){
      const m = location.hash && location.hash.match(/access_token=([^&]+)/);
      if (m) {
        const t = decodeURIComponent(m[1]);
        log('[admin] Found token in hash');
        storeToken(t);
        // Clean URL hash so it doesn't stick around
        try { history.replaceState(null, '', location.pathname + location.search); } catch(e){}
      }
    })();

    // 2) Listen for postMessage from the OAuth popup (all known formats)
    window.addEventListener('message', (e) => {
      const d = e.data;
      let token = null;
      if (typeof d === 'string') {
        const m = d.match(/^authorization:github:success:([^]+)$/);
        if (m) token = m[1];
      }
      if (!token && d && typeof d === 'object') {
        if (d.token) token = d.token;
        if (!token && d.type === 'authorization:github' && d.status === 'success' && d.token) token = d.token;
      }
      if (token) {
        log('[admin] Received token via postMessage');
        storeToken(token);
        initCMS(); // init without reloading
      }
    });

    // 3) If a token already exists (previous login), just init now
    (function initIfTokenPresent(){
      const t = localStorage.getItem('decap-cms-oauth-token') || localStorage.getItem('netlify-cms-oauth-token');
      if (t) {
        log('[admin] Token already in storage, initializing CMS');
        initCMS();
      } else {
        log('[admin] No token in storage yet, waiting for login popup…');
      }
    })();
  </script>
</body>
</html>
