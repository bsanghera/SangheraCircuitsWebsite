<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Meditation Admin</title>
</head>
<body>
  <!-- Shim: capture token from popup in any format, store it where Decap expects, then reload -->
  <script>
    (function () {
      function storeAndReload(token) {
        try {
          // cover both Decap and legacy Netlify CMS key names
          localStorage.setItem('decap-cms-oauth-token', token);
          localStorage.setItem('netlify-cms-oauth-token', token);
        } catch (e) {}
        // clean any access_token hash that the Worker may have added
        try { history.replaceState(null, '', location.pathname + location.search); } catch (e) {}
        location.reload();
      }

      // 1) If the Worker put #access_token in the URL, use it
      (function fromHash() {
        var m = location.hash && location.hash.match(/access_token=([^&]+)/);
        if (m) storeAndReload(decodeURIComponent(m[1]));
      })();

      // 2) Listen for postMessage from the Worker popup (all known formats)
      window.addEventListener('message', function (e) {
        var d = e.data; var token = null;
        if (typeof d === 'string') {
          var m = d.match(/^authorization:github:success:([^]+)$/);
          if (m) token = m[1];
        }
        if (!token && d && typeof d === 'object') {
          if (d.token) token = d.token;
          if (!token && d.type === 'authorization:github' && d.status === 'success' && d.token) token = d.token;
        }
        if (token) storeAndReload(token);
      });
    })();
  </script>

  <!-- Load Decap CMS -->
  <script src="https://unpkg.com/decap-cms@^3.3.0/dist/decap-cms.js"></script>
</body>
</html>
